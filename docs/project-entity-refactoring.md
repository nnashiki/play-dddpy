# Projectエンティティのリファクタリング: 永続化専用のファクトリ／ローダーの除去

## 概要

このドキュメントでは、DDDアーキテクチャにおいて「エンティティから永続化専用のファクトリ／ローダーを追い出す」リファクタリングの方針を説明します。Data Mapper パターンを採用しています。API 出力用は Assembly パターンを使用し、名称を区別しています。

## 背景と課題

### Before（修正前）
- `Project.from_persistence()` および `Project._load_todos()` によって、ドメインエンティティと永続化層が双方向依存している
- エンティティ内で後からコレクションを差し替える仕組みが存在し、不変条件の維持が困難
- テスト時にエンティティの生成がInfrastructure層の詳細に依存してしまう

### After（修正後）
- Infrastructure → Domain の片方向依存に整理
- Data-Mapper パターンを採用し、集約を完成形で生成
- ドメインエンティティが永続化詳細を一切知らない状態を実現

## 設計方針

### 1. レイヤ間依存方向の原則

DDDにおけるレイヤ間依存は以下の方向性を保つべきです：

```
Presentation → Application → Domain ← Infrastructure
```

Infrastructure層はDomain層に依存するが、Domain層はInfrastructure層に依存してはいけません。

### 2. Data-Mapperパターンの採用

永続化とドメインモデル間の変換責務を専用のMapperクラスに集約します：

- **ProjectMapper**: DTO ↔ ドメインエンティティの変換を担当
- **集約完成原則**: Mapperは常に完成した集約を返す（部分的な状態を公開しない）
- **単一責任原則**: 変換ロジックをMapperに集約し、エンティティは純粋にビジネスロジックに専念

### 3. 不変条件の保護

- エンティティの内部状態を後から変更する`_load_todos()`のようなメソッドを排除
- コンストラクタで完全な状態を設定し、その後は正当なビジネス操作のみで状態変更
- 集約ルートとしての整合性を保証

## 実装アプローチ

### 1. ドメイン層の純化

```python
# 削除されたメソッド
- Project.from_persistence()  # Infrastructure詳細への依存
- Project._load_todos()       # 後からの状態変更
```

### 2. ProjectMapperの新設

```python
class ProjectMapper:
    @staticmethod
    def to_entity(project_row: ProjectModel, todo_rows: list[TodoModel]) -> Project:
        """DTO → ドメインエンティティ（集約完成形で返す）"""
        # 関連するTodoも含めて完全な集約を構築
        
    @staticmethod
    def from_entity(project: Project) -> ProjectModel:
        """ドメインエンティティ → DTO"""
```

### 3. Repository実装の変更

- `ProjectModel.to_entity()`を削除し、Mapper経由でのみ変換
- 集約とその関連エンティティを一括で取得・変換

## メリット

### 1. アーキテクチャの健全性
- レイヤ間依存が正しい方向に整理される
- ドメイン層が純粋になり、ビジネスロジックに集中できる

### 2. テスタビリティの向上
- ドメインエンティティをInfrastructure層に依存せずに生成可能
- テストでのStub/Mockが容易になる

### 3. 保守性の向上
- 変換ロジックがMapperに集約され、変更箇所が明確
- エンティティの不変条件が確実に保護される

### 4. 可読性の向上
- 各クラスの責務が明確に分離される
- コードの意図が理解しやすくなる

## 移行時の注意点

### 1. 既存コードへの影響
- `Project.from_persistence()`や`_load_todos()`を使用している箇所のチェック
- テストコードでの生成方法の見直し

### 2. データ整合性の確認
- Mapper経由での変換が正確に動作することの確認
- 関連エンティティ（Todo）が正しく関連付けられることの確認

### 3. パフォーマンスの考慮
- 集約完成のためのクエリ最適化
- N+1問題の回避

## 今後の拡張性

この設計パターンは他の集約にも適用可能であり、システム全体のアーキテクチャ品質向上に寄与します：

- 他のエンティティでも同様のMapperパターンを採用
- 複雑な集約関係がある場合の標準的なアプローチとして活用
- ドメイン駆動設計の原則に沿った持続可能な開発体制の構築

## 結論

このリファクタリングにより、DDDの原則に沿った健全なアーキテクチャを実現し、保守性、テスタビリティ、可読性の全ての面で改善を達成しました。永続化の詳細がドメイン層から完全に分離され、各レイヤの責務が明確になったことで、今後の機能拡張や変更に対してより柔軟に対応できる基盤が整いました。
